name: Build APK
on:
  repository_dispatch:
    types: [build-apk]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      - name: Create Flutter Project
        run: |
          flutter create --org com.appforge --project-name appforge_app .
          rm -rf lib/main.dart test/

      - name: Write Project Files
        env:
          PROJECT_FILES: ${{ toJson(github.event.client_payload.project_files) }}
        run: |
          echo "$PROJECT_FILES" > files.json
          node -e "
            const fs = require('fs');
            const path = require('path');
            const files = JSON.parse(fs.readFileSync('files.json', 'utf8'));
            Object.entries(files).forEach(([fpath, content]) => {
                if(fpath.includes('.github')) return; 
                const p = path.resolve(fpath);
                fs.mkdirSync(path.dirname(p), { recursive: true });
                fs.writeFileSync(p, content);
                console.log('Written:', fpath);
            });
          "
          
      - name: Update build.gradle (SDK Versions)
        run: |
             sed -i 's/minSdkVersion flutter.minSdkVersion/minSdkVersion 21/g' android/app/build.gradle
             sed -i 's/targetSdkVersion flutter.targetSdkVersion/targetSdkVersion 34/g' android/app/build.gradle
             sed -i 's/compileSdkVersion flutter.compileSdkVersion/compileSdkVersion 34/g' android/app/build.gradle

      - name: Get Dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release --no-tree-shake-icons

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: build/app/outputs/flutter-apk/app-release.apk
